---
title: "Tidyverse"
author: "Berk Ali Cam"
---

 
```{r}
library(tidyverse)
library(readxl)
library(lubridate)

# Load the dataset
bike_orderlines_wrangled_tbl <- read_rds('../../assets/datasets/bike_orderlines_wrangled_tbl.rds')

#---- Part-1 ----

# Extract state and city
bike_orderlines_wrangled_tbl <- bike_orderlines_wrangled_tbl %>%
  separate(col = location, into = c("city", "state"), sep = ", ")

# Calculate sales by state
sales_by_state_tbl <- bike_orderlines_wrangled_tbl %>%
  group_by(state) %>%
  summarize(sales = sum(total_price)) %>%
  ungroup() %>%
  mutate(sales_text = scales::dollar(sales, big.mark = ".",
                                     decimal.mark = ",",
                                     prefix = "",
                                     suffix = " €"))

# Get the state with the highest revenue
highest_revenue_state <- sales_by_state_tbl %>%
  arrange(desc(sales)) %>%
  slice(1)
print(highest_revenue_state)

# Bar plot of sales by state
sales_by_state_tbl %>%
  ggplot(aes(x = state, y = sales, fill = state)) +
  geom_col() +   
  scale_y_continuous(labels = scales::dollar_format(big.mark = ".",
                                                    decimal.mark = ",",
                                                    prefix = "",
                                                    suffix = " €")) +
  labs(title = "Revenue by State",
       x = "State",
       y = "Sales") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels

#---- Part-2 ----

# Calculate sales by state and year
sales_by_state_year_tbl <- bike_orderlines_wrangled_tbl %>%
  group_by(state, year = year(order_date)) %>%
  summarize(sales = sum(total_price)) %>%
  ungroup() %>%
  mutate(sales_text = scales::dollar(sales, big.mark = ".",
                                     decimal.mark = ",",
                                     prefix = "",
                                     suffix = " €"))

# Faceted bar plot of sales by state and year
sales_by_state_year_tbl %>%
  ggplot(aes(x = year, y = sales, fill = state)) +
  geom_col() +
  facet_wrap(~ state) +
  scale_y_continuous(labels = scales::dollar_format(big.mark = ".",
                                                    decimal.mark = ",",
                                                    prefix = "",
                                                    suffix = " €")) +
  labs(title = "Revenue by State & Year",
       x = "Year",
       y = "Sales") +
  facet_wrap(~ state, ncol = 3) +   # Create 12 facets (4 rows x 3 columns)
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels
```

